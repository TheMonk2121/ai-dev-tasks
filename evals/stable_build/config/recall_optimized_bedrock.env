# Recall-Optimized Bedrock Configuration — Locked when loaded
# Purpose: Boost recall significantly while preserving precision safeguards
# Usage:
#   - python:  uv run python scripts/ragchecker_official_evaluation.py --use-bedrock --bypass-cli --profile recall
#   - shell :  source scripts/recall_optimized_eval.sh

# =============================================================================
# RATE LIMITING (safe but less throttled than stable)
# =============================================================================
export USE_BEDROCK_QUEUE=1
export BEDROCK_MAX_IN_FLIGHT=1          # keep single in-flight for stability
export BEDROCK_MAX_RPS=0.18             # modestly higher than stable to offset JSON/coverage
export BEDROCK_COOLDOWN_SEC=20
export BEDROCK_MAX_RETRIES=8
export BEDROCK_RETRY_BASE=1.8
export BEDROCK_RETRY_MAX_SLEEP=20

# =============================================================================
# MODEL + REGION (same as stable unless overridden by environment)
# =============================================================================
export AWS_REGION=us-east-1
export BEDROCK_MODEL_ID=anthropic.claude-3-haiku-20240307-v1:0

# =============================================================================
# GENERATION KNOBS — enable coverage-first behavior for recall
# =============================================================================
export RAGCHECKER_COVERAGE_REWRITE=1    # enable coverage-driven compose
export RAGCHECKER_JSON_PROMPTS=1        # allow JSON extraction/scoring
export RAGCHECKER_JSON_MAX_TOKENS=900

# =============================================================================
# CONTEXT EXPANSION — provide more evidence to generator and judge
# =============================================================================
export RAGCHECKER_CONTEXT_TOPK=15       # increase top-k contexts used in prompts
export RAGCHECKER_EXTRACTIVE_CTX_TOPK=8
export RAGCHECKER_EXTRACTIVE_TOPK=7
export RAGCHECKER_JUDGE_CONTEXT_TOPK=8

# =============================================================================
# EVIDENCE SELECTION — dynamic K tuned for recall with safeguards
# =============================================================================
export RAGCHECKER_EVIDENCE_KEEP_MODE=target_k
export RAGCHECKER_TARGET_K_WEAK=4
export RAGCHECKER_TARGET_K_BASE=7
export RAGCHECKER_TARGET_K_STRONG=11
export RAGCHECKER_EVIDENCE_MIN_SENT=2
export RAGCHECKER_EVIDENCE_MAX_SENT=11

# Signal delta thresholds (lowered to favor stronger evidence selection)
export RAGCHECKER_SIGNAL_DELTA_WEAK=0.05    # vs default 0.10
export RAGCHECKER_SIGNAL_DELTA_STRONG=0.15  # vs default 0.22

# Guard thresholds slightly relaxed for recall, still conservative
export RAGCHECKER_EVIDENCE_GUARD=1
export RAGCHECKER_EVIDENCE_JACCARD=0.12
export RAGCHECKER_EVIDENCE_COVERAGE=0.30

# =============================================================================
# META — mark as locked when chosen by the runner
# =============================================================================
# The runner sets RAGCHECKER_LOCK_ENV=1 when loading this profile.
# Last updated: 2025-09-05
