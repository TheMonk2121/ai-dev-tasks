# Precision Optimized Bedrock Configuration
# Based on analysis: Need +1.8 precision points to clear Haiku baseline
# Current: P=0.117, R=0.165, F1=0.133
# Target: P≥0.135, R~0.16, F1≥0.145

# =============================================================================
# STABLE RATE LIMITING (Anti-Throttling - Proven Settings)
# =============================================================================

# Queue Client Concurrency Control (Critical for USE_BEDROCK_QUEUE=1)
export USE_BEDROCK_QUEUE=1
export ASYNC_MAX_CONCURRENCY=1
export BEDROCK_MAX_CONCURRENCY=1

# Evaluator-Level Rate Limiting (Conservative - Proven to work)
export BEDROCK_MAX_RPS=0.15
export BEDROCK_COOLDOWN_SEC=30
export BEDROCK_RETRY_MAX=8
export BEDROCK_RETRY_BASE=1.8
export BEDROCK_RETRY_MAX_SLEEP=20

# Disable Coverage Rewrite (Major Source of Bedrock Calls)
export RAGCHECKER_COVERAGE_REWRITE=0

# Reduce JSON Usage (Prevent Repair Loops)
export RAGCHECKER_JSON_PROMPTS=0
export RAGCHECKER_JSON_MAX_TOKENS=200

# =============================================================================
# PRECISION OPTIMIZATION PARAMETERS
# =============================================================================

# A) Precision-first ranking (fastest win)
export RAGCHECKER_CE_WEIGHT=0.28                  # Up from 0.16
export RAGCHECKER_CE_RERANK_ENABLE=1
export RAGCHECKER_CE_RERANK_TOPN=10               # Down from 80

# B) BM25 anchor bias reduction
export RAGCHECKER_BM25_BOOST_ANCHORS=1.3          # Down from 1.9

# C) Retrieval optimization
export RETRIEVER_TOP_K=100
export MMR_LAMBDA=0.2

# D) Answer shaping
export ANSWER_EVIDENCE_GATE=0.60

# E) Evidence selection (keep current floors)
export RAGCHECKER_EVIDENCE_JACCARD=0.07
export RAGCHECKER_EVIDENCE_COVERAGE=0.20

# F) Fusion configuration
export RAGCHECKER_RRF_K=50
export RAGCHECKER_FACET_DOWNWEIGHT_NO_ANCHOR=0.72
export RAGCHECKER_PER_DOC_LINE_CAP=8

# G) Risk-aware precision gates
export RAGCHECKER_SUPPORT_TWO_OF_THREE=1
export RAGCHECKER_RISKY_REQUIRE_ALL=1
export RAGCHECKER_NUMERIC_MUST_MATCH=1
export RAGCHECKER_ENTITY_MUST_MATCH=1

# H) NLI for borderline cases
export RAGCHECKER_NLI_ENABLE=1
export RAGCHECKER_NLI_ON_BORDERLINE=1
export RAGCHECKER_BORDERLINE_BAND=0.02
export RAGCHECKER_NLI_P_THRESHOLD=0.65

# I) Telemetry
export RAGCHECKER_TELEMETRY_ENABLED=1
export RAGCHECKER_LOG_CE_USED_PERCENT=1
export RAGCHECKER_LOG_FUSION_GAIN=1
export RAGCHECKER_LOG_ANCHOR_COVERAGE=1

# AWS Configuration
export AWS_REGION=us-east-1
export BEDROCK_MODEL_ID=anthropic.claude-3-haiku-20240307-v1:0

# =============================================================================
# CONFIGURATION NOTES
# =============================================================================
# This configuration implements the precision optimization strategy:
# 1. Increased cross-encoder weight (0.28 vs 0.16)
# 2. Reduced rerank top-n (10 vs 80) for better precision
# 3. Reduced BM25 anchor boost (1.3 vs 1.9) to reduce lexical bias
# 4. Added MMR for diversity (λ=0.2)
# 5. Added answer evidence gating (τ=0.60)
# Expected: P +1.0-2.0 pts, Recall -0.2-0.6 pts, Net F1 ↑
