<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Import Graph</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; background: #f7f7f7; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    #graph { width: 100%; height: 680px; border: 1px solid #e1e1e1; border-radius: 6px; }
    .controls { margin: 12px 0; display: flex; gap: 8px; flex-wrap: wrap; }
    button { background: #0d6efd; color: #fff; border: 0; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0b5ed7; }
    input[type="text"] { padding: 8px; width: 320px; }
    .tooltip { position: absolute; background: rgba(0,0,0,0.8); color: #fff; padding: 6px 8px; border-radius: 4px; font-size: 12px; pointer-events: none; }
  </style>
  <!-- Note: This page loads a local JSON file (import_graph.json). Open from the repo to view. -->
  <!-- If your browser blocks file access, use an IDE preview or a simple http server. -->
  <!-- python -m http.server -d metrics/visualizations 8000 -->
</head>
<body>
  <div class="container">
    <h2>Import Graph</h2>
    <div class="controls">
      <button id="reset">Reset</button>
      <button id="toggle-labels">Toggle Labels</button>
      <input id="filter" type="text" placeholder="Filter path contains (e.g., src/retrieval)" />
      <button id="apply-filter">Apply Filter</button>
      <button id="clear-filter">Clear Filter</button>
    </div>
    <div id="stats"></div>
    <div id="graph"></div>
  </div>

  <script>
    const width = document.getElementById('graph').offsetWidth;
    const height = 680;
    let showLabels = false;
    let fullData = null;
    let currentNodes = null;
    let currentEdges = null;

    const svg = d3.select('#graph').append('svg')
      .attr('width', width)
      .attr('height', height);

    const container = svg.append('g');
    const linkLayer = container.append('g');
    const nodeLayer = container.append('g');
    const labelLayer = container.append('g');

    const zoom = d3.zoom().scaleExtent([0.2, 3]).on('zoom', (event) => {
      container.attr('transform', event.transform);
    });
    svg.call(zoom);

    const tooltip = d3.select('body').append('div')
      .attr('class', 'tooltip').style('opacity', 0);

    function render(nodes, edges) {
      svg.selectAll('*');
      container.selectAll('*').remove();

      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(edges).id(d => d.id).distance(80))
        .force('charge', d3.forceManyBody().strength(-250))
        .force('center', d3.forceCenter(width/2, height/2))
        .force('collide', d3.forceCollide().radius(20));

      const link = linkLayer.selectAll('line').data(edges).enter().append('line')
        .attr('stroke', '#aaa').attr('stroke-opacity', .6);

      const node = nodeLayer.selectAll('circle').data(nodes).enter().append('circle')
        .attr('r', d => Math.min(16, Math.max(5, (d.imported_by||0)/2 + 5)))
        .attr('fill', d => (d.imported_by||0) > 10 ? '#ff6b6b' : (d.imported_by||0) > 5 ? '#4ecdc4' : '#45b7d1')
        .on('mouseover', (event, d) => {
          tooltip.transition().duration(150).style('opacity', .95);
          tooltip.html(`<strong>${d.id}</strong><br/>imports: ${d.imports||0} | imported_by: ${d.imported_by||0}`)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 28) + 'px');
        })
        .on('mouseout', () => tooltip.transition().duration(250).style('opacity', 0))
        .call(d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended));

      const label = labelLayer.selectAll('text').data(nodes).enter().append('text')
        .text(d => d.id.split('/').pop().replace('.py',''))
        .attr('font-size', '10px')
        .style('display', showLabels ? 'block' : 'none');

      simulation.on('tick', () => {
        link.attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        node.attr('cx', d => d.x).attr('cy', d => d.y);
        label.attr('x', d => d.x + 8).attr('y', d => d.y + 4);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
      function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

      document.getElementById('stats').innerText = `Nodes: ${nodes.length} | Edges: ${edges.length}`;
      currentNodes = nodes; currentEdges = edges;
    }

    function applyFilter(text) {
      if (!fullData) return;
      if (!text) { render(fullData.nodes, fullData.edges); return; }
      const nodes = fullData.nodes.filter(n => n.id.includes(text));
      const nodeSet = new Set(nodes.map(n => n.id));
      const edges = fullData.edges.filter(e => nodeSet.has(e.source) && nodeSet.has(e.target));
      render(nodes, edges);
    }

    fetch('import_graph.json')
      .then(r => r.json())
      .then(data => {
        // transform edges to objects D3 expects
        fullData = {
          nodes: data.nodes,
          edges: data.edges.map(e => ({ source: e.source, target: e.target }))
        };
        render(fullData.nodes, fullData.edges);
      });

    document.getElementById('reset').onclick = () => {
      svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity);
    };
    document.getElementById('toggle-labels').onclick = () => {
      showLabels = !showLabels;
      if (currentNodes) render(currentNodes, currentEdges);
    };
    document.getElementById('apply-filter').onclick = () => {
      const text = (document.getElementById('filter')).value;
      applyFilter(text);
    };
    document.getElementById('clear-filter').onclick = () => {
      (document.getElementById('filter')).value = '';
      applyFilter('');
    };
  </script>
</body>
</html>

