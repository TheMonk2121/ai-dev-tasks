# Code Compliance & Writing Standards

## Code Quality Standards

### Python Code Standards
- **Type hints required** in all Python files
- **Unit tests required** for new features
- **Maximum function length**: 50 lines
- **Document all public functions and classes** with docstrings
- **Use black for Python formatting**
- **Prefer local-first solutions** over external dependencies
- **Avoid broad `# type: ignore` comments** - use scoped and justified ignores instead

### Code Writing Principles
- **Search before writing**: Use `codebase_search` to find existing solutions
- **70% reuse target**: Aim to reuse existing code rather than writing new
- **Tests first**: Write tests before implementing features
- **Concise responses**: Provide concise code fixes when requested
- **Avoid over-complication**: Prefer simple, maintainable solutions

### Error Handling
- **Graceful degradation**: Handle errors without breaking the system
- **Comprehensive logging**: Use structured logging for debugging
- **Retry mechanisms**: Implement retry wrappers for external dependencies
- **Input validation**: Validate all inputs, especially user-provided data

## Tool Usage Standards

### Search & Discovery
- **Prefer `codebase_search`** over `grep_search` for semantic searches
- **Use `file_search`** for fuzzy filename matching
- **Leverage `list_dir`** to understand project structure

### Task Management
- **Use `todo_write`** for tracking multi-step tasks
- **Update memory** for important project decisions
- **Track progress** with clear acceptance criteria

### Validation & Testing
- **Run linter checks** before committing changes
- **Validate PRD-backlog linkage**: `python3 scripts/validate_prd_backlog_linkage.py`
- **Test critical paths** before deployment

## Code Organization

### File Structure
- **Follow existing patterns** in the codebase
- **Use descriptive filenames** that indicate purpose
- **Group related functionality** in appropriate directories
- **Maintain consistent imports** and dependencies

### Documentation
- **Inline comments** for complex logic
- **README files** for new modules
- **API documentation** for public interfaces
- **Update guides** when adding new patterns

## Security & Best Practices

### Input Validation
- **Sanitize all inputs** before processing
- **Validate file paths** to prevent path traversal
- **Check permissions** before file operations
- **Use parameterized queries** for database operations

### Error Messages
- **Don't expose sensitive information** in error messages
- **Provide actionable error messages** for users
- **Log detailed errors** for debugging
- **Handle edge cases** gracefully

## Performance Considerations

### Optimization
- **Profile before optimizing** - measure first
- **Use appropriate data structures** for the task
- **Consider memory usage** for large datasets
- **Cache expensive operations** when appropriate

### Resource Management
- **Close file handles** and database connections
- **Use context managers** for resource cleanup
- **Monitor memory usage** in long-running processes
- **Implement timeouts** for external calls

## Error Reduction Governance

### Error Reduction Standards
- **Follow governance rules**: All error reduction lessons must be organized by error code in `400_guides/400_comprehensive-coding-best-practices.md`
- **Use decision matrix**: Apply only safe auto-fixes (RUF001, F401, I001, F541); avoid dangerous ones (PT009, B007, RUF013, F841, RUF010)
- **Document anti-patterns**: Include specific commands that failed and error counts (before/after)
- **Test fixes**: Verify all error reduction approaches before documenting

### Safe Auto-Fixes (Use These)
- **RUF001**: Use `scripts/fix_unicode_characters.py` for Unicode character replacement
- **F401**: Use `ruff check --select F401 --fix` for unused imports
- **I001**: Use `ruff check --select I001 --fix` for import formatting
- **F541**: Use `ruff check --select F541 --fix` for f-string issues

### Dangerous Auto-Fixes (Avoid These)
- **PT009**: Manual inspection required - auto-fix multiplies errors (127→1328)
- **B007**: Manual inspection required - auto-fix multiplies errors (35→206)
- **RUF013**: Manual inspection required - auto-fix multiplies errors (29→213)
- **F841**: Manual inspection required - auto-fix increases errors (24→41)
- **RUF010**: Manual inspection required - auto-fix doubles errors (12→24)

### Error Reduction Tools
- **Smart fixes**: Use `python3.12 scripts/smart_error_fix.py <target_paths>` for safe auto-fixes only
- **Validation**: Run `ruff check --select <ERROR_CODE>` to verify fixes
- **Documentation**: Update `400_guides/400_comprehensive-coding-best-practices.md` with new lessons learned

## Testing Standards

### Test Coverage
- **Unit tests** for all new functions
- **Integration tests** for complex workflows
- **Edge case testing** for error conditions
- **Performance tests** for critical paths

### Test Quality
- **Clear test names** that describe the scenario
- **Isolated tests** that don't depend on each other
- **Mock external dependencies** to avoid flaky tests
- **Test both success and failure cases**
