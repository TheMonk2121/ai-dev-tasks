<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Mission Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --border-color: #404040;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--card-bg) !important;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: rgba(0, 123, 255, 0.1);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .mission-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .status-pending { background-color: var(--warning-color); color: #000; }
        .status-running { background-color: var(--info-color); color: #fff; }
        .status-completed { background-color: var(--success-color); color: #fff; }
        .status-failed { background-color: var(--danger-color); color: #fff; }
        .status-cancelled { background-color: #6c757d; color: #fff; }
        
        .priority-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .priority-low { background-color: #6c757d; color: #fff; }
        .priority-medium { background-color: var(--info-color); color: #fff; }
        .priority-high { background-color: var(--warning-color); color: #000; }
        .priority-critical { background-color: var(--danger-color); color: #fff; }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
        }
        
        .metrics-card {
            text-align: center;
            padding: 20px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .real-time-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
            animation: pulse 2s infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .mission-details {
            font-size: 0.9em;
            color: #ccc;
        }
        
        .mission-title {
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        
        .mission-description {
            color: #ccc;
            font-style: italic;
        }
        
        .btn-action {
            font-size: 0.8em;
            padding: 4px 8px;
            margin: 2px;
        }
        
        .filters {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .form-control, .form-select {
            background-color: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--dark-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-color);
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status">
        <div class="toast" role="alert" id="connectionToast">
            <div class="toast-header">
                <span class="real-time-indicator" id="connectionIndicator"></span>
                <strong class="me-auto">Connection Status</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="connectionMessage">
                Connecting...
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-rocket"></i> Mission Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock"></i> <span id="currentTime"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Metrics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="metric-value" id="totalMissions">0</div>
                    <div class="metric-label">Total Missions</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="metric-value" id="runningMissions">0</div>
                    <div class="metric-label">Running</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="metric-value" id="avgDuration">0s</div>
                    <div class="metric-label">Avg Duration</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="row">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="running">Running</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="priorityFilter" class="form-label">Priority</label>
                    <select class="form-select" id="priorityFilter">
                        <option value="">All Priorities</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchFilter" class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchFilter" placeholder="Search missions...">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success" onclick="showCreateMissionModal()">
                            <i class="fas fa-plus"></i> New Mission
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading missions...</p>
        </div>

        <!-- Missions Grid -->
        <div class="row" id="missionsGrid">
            <!-- Missions will be dynamically loaded here -->
        </div>
    </div>

    <!-- Create Mission Modal -->
    <div class="modal fade" id="createMissionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Mission</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createMissionForm">
                        <div class="mb-3">
                            <label for="missionTitle" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="missionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="missionDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="missionDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="missionPriority" class="form-label">Priority</label>
                            <select class="form-select" id="missionPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createMission()">Create Mission</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Details Modal -->
    <div class="modal fade" id="missionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="missionDetailsTitle">Mission Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="missionDetailsBody">
                    <!-- Mission details will be loaded here -->
                </div>
                <div class="modal-footer" id="missionDetailsFooter">
                    <!-- Action buttons will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let missions = [];
        let currentFilters = {
            status: '',
            priority: '',
            search: ''
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadMissions();
        });

        // Socket.IO initialization
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true, 'Connected');
                showToast('Connected to server', 'success');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false, 'Disconnected');
                showToast('Disconnected from server', 'warning');
            });
            
            socket.on('initial_data', function(data) {
                missions = data.missions || [];
                updateMetrics(data.metrics);
                renderMissions();
            });
            
            socket.on('mission_update', function(data) {
                updateMission(data.mission);
                updateMetrics(data.metrics);
            });
            
            socket.on('metrics_update', function(data) {
                updateMetrics(data.metrics);
            });
            
            socket.on('data_update', function(data) {
                missions = data.missions || [];
                updateMetrics(data.metrics);
                renderMissions();
            });
        }

        // Update connection status
        function updateConnectionStatus(connected, message) {
            const indicator = document.getElementById('connectionIndicator');
            const messageEl = document.getElementById('connectionMessage');
            
            if (connected) {
                indicator.style.backgroundColor = 'var(--success-color)';
                indicator.style.animation = 'pulse 2s infinite';
            } else {
                indicator.style.backgroundColor = 'var(--danger-color)';
                indicator.style.animation = 'none';
            }
            
            messageEl.textContent = message;
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        // Load missions from API
        function loadMissions() {
            showLoading(true);
            
            fetch('/api/missions')
                .then(response => response.json())
                .then(data => {
                    missions = data.missions || [];
                    renderMissions();
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error loading missions:', error);
                    showToast('Error loading missions', 'error');
                    showLoading(false);
                });
        }

        // Render missions
        function renderMissions() {
            const grid = document.getElementById('missionsGrid');
            const filteredMissions = filterMissions();
            
            if (filteredMissions.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5>No missions found</h5>
                                <p class="text-muted">No missions match your current filters.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = filteredMissions.map(mission => createMissionCard(mission)).join('');
        }

        // Filter missions
        function filterMissions() {
            return missions.filter(mission => {
                const statusMatch = !currentFilters.status || mission.status === currentFilters.status;
                const priorityMatch = !currentFilters.priority || mission.priority === currentFilters.priority;
                const searchMatch = !currentFilters.search || 
                    mission.title.toLowerCase().includes(currentFilters.search.toLowerCase()) ||
                    mission.description.toLowerCase().includes(currentFilters.search.toLowerCase());
                
                return statusMatch && priorityMatch && searchMatch;
            });
        }

        // Create mission card
        function createMissionCard(mission) {
            const statusClass = `status-${mission.status}`;
            const priorityClass = `priority-${mission.priority}`;
            const progress = mission.progress || 0;
            
            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card mission-card" onclick="showMissionDetails('${mission.id}')">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="status-badge ${statusClass}">${mission.status.toUpperCase()}</span>
                            <span class="priority-badge ${priorityClass}">${mission.priority.toUpperCase()}</span>
                        </div>
                        <div class="card-body">
                            <div class="mission-title">${mission.title}</div>
                            <div class="mission-description">${mission.description || 'No description'}</div>
                            <div class="mission-details mt-2">
                                <small>
                                    <i class="fas fa-clock"></i> ${formatDate(mission.created_at)}<br>
                                    ${mission.agent_type ? `<i class="fas fa-robot"></i> ${mission.agent_type}<br>` : ''}
                                    ${mission.model_used ? `<i class="fas fa-brain"></i> ${mission.model_used}<br>` : ''}
                                    ${mission.duration ? `<i class="fas fa-stopwatch"></i> ${formatDuration(mission.duration)}<br>` : ''}
                                </small>
                            </div>
                            ${mission.status === 'running' ? `
                                <div class="progress mt-2">
                                    <div class="progress-bar" role="progressbar" style="width: ${progress}%" 
                                         aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                        ${progress}%
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Update mission in the list
        function updateMission(updatedMission) {
            const index = missions.findIndex(m => m.id === updatedMission.id);
            if (index !== -1) {
                missions[index] = updatedMission;
            } else {
                missions.unshift(updatedMission);
            }
            renderMissions();
        }

        // Update metrics
        function updateMetrics(metrics) {
            if (!metrics) return;
            
            document.getElementById('totalMissions').textContent = metrics.total_missions || 0;
            document.getElementById('runningMissions').textContent = metrics.running_missions || 0;
            document.getElementById('successRate').textContent = `${(metrics.success_rate || 0).toFixed(1)}%`;
            document.getElementById('avgDuration').textContent = formatDuration(metrics.average_duration || 0);
        }

        // Show mission details
        function showMissionDetails(missionId) {
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            const modal = new bootstrap.Modal(document.getElementById('missionDetailsModal'));
            const title = document.getElementById('missionDetailsTitle');
            const body = document.getElementById('missionDetailsBody');
            const footer = document.getElementById('missionDetailsFooter');
            
            title.textContent = mission.title;
            
            body.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Mission Information</h6>
                        <p><strong>Status:</strong> <span class="status-badge status-${mission.status}">${mission.status.toUpperCase()}</span></p>
                        <p><strong>Priority:</strong> <span class="priority-badge priority-${mission.priority}">${mission.priority.toUpperCase()}</span></p>
                        <p><strong>Created:</strong> ${formatDate(mission.created_at)}</p>
                        ${mission.started_at ? `<p><strong>Started:</strong> ${formatDate(mission.started_at)}</p>` : ''}
                        ${mission.completed_at ? `<p><strong>Completed:</strong> ${formatDate(mission.completed_at)}</p>` : ''}
                        ${mission.duration ? `<p><strong>Duration:</strong> ${formatDuration(mission.duration)}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>Technical Details</h6>
                        ${mission.agent_type ? `<p><strong>Agent:</strong> ${mission.agent_type}</p>` : ''}
                        ${mission.model_used ? `<p><strong>Model:</strong> ${mission.model_used}</p>` : ''}
                        ${mission.tokens_used ? `<p><strong>Tokens:</strong> ${mission.tokens_used.toLocaleString()}</p>` : ''}
                        ${mission.cost_estimate ? `<p><strong>Cost:</strong> $${mission.cost_estimate.toFixed(4)}</p>` : ''}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Description</h6>
                        <p>${mission.description || 'No description provided'}</p>
                    </div>
                </div>
                ${mission.error_message ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-danger">Error</h6>
                            <p class="text-danger">${mission.error_message}</p>
                        </div>
                    </div>
                ` : ''}
                ${mission.result ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Result</h6>
                            <pre class="bg-dark p-2 rounded"><code>${JSON.stringify(mission.result, null, 2)}</code></pre>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Action buttons based on status
            let actionButtons = '';
            if (mission.status === 'pending') {
                actionButtons = `<button class="btn btn-primary" onclick="startMission('${mission.id}')">Start Mission</button>`;
            } else if (mission.status === 'running') {
                actionButtons = `<button class="btn btn-warning" onclick="cancelMission('${mission.id}')">Cancel Mission</button>`;
            }
            
            footer.innerHTML = actionButtons;
            modal.show();
        }

        // Mission actions
        function startMission(missionId) {
            fetch(`/api/missions/${missionId}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('missionDetailsModal')).hide();
                }
            })
            .catch(error => {
                console.error('Error starting mission:', error);
                showToast('Error starting mission', 'error');
            });
        }

        function cancelMission(missionId) {
            if (!confirm('Are you sure you want to cancel this mission?')) return;
            
            fetch(`/api/missions/${missionId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('missionDetailsModal')).hide();
                }
            })
            .catch(error => {
                console.error('Error cancelling mission:', error);
                showToast('Error cancelling mission', 'error');
            });
        }

        // Create new mission
        function showCreateMissionModal() {
            document.getElementById('createMissionForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('createMissionModal'));
            modal.show();
        }

        function createMission() {
            const title = document.getElementById('missionTitle').value;
            const description = document.getElementById('missionDescription').value;
            const priority = document.getElementById('missionPriority').value;
            
            if (!title) {
                showToast('Title is required', 'error');
                return;
            }
            
            fetch('/api/missions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    priority: priority
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createMissionModal')).hide();
                    loadMissions();
                }
            })
            .catch(error => {
                console.error('Error creating mission:', error);
                showToast('Error creating mission', 'error');
            });
        }

        // Filter handling
        document.getElementById('statusFilter').addEventListener('change', function() {
            currentFilters.status = this.value;
            renderMissions();
        });

        document.getElementById('priorityFilter').addEventListener('change', function() {
            currentFilters.priority = this.value;
            renderMissions();
        });

        document.getElementById('searchFilter').addEventListener('input', function() {
            currentFilters.search = this.value;
            renderMissions();
        });

        // Utility functions
        function refreshData() {
            loadMissions();
            showToast('Data refreshed', 'info');
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function showToast(message, type) {
            const toast = new bootstrap.Toast(document.getElementById('connectionToast'));
            document.getElementById('connectionMessage').textContent = message;
            toast.show();
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        function formatDuration(seconds) {
            if (!seconds) return '0s';
            if (seconds < 60) return `${Math.round(seconds)}s`;
            if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
            return `${Math.round(seconds / 3600)}h ${Math.round((seconds % 3600) / 60)}m`;
        }
    </script>
</body>
</html> 